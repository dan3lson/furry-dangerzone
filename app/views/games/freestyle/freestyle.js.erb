const $scoreboardPartial = $("<%= j render(partial: 'games/scoreboard') %>");
const $headerPartial = $("<%= j render(partial: 'games/fundamentals/header', locals: { target_word: @target_word }) %>");
const $directionsPartial = $("<%= j render(partial: 'games/directions', locals: { directions: '' }) %>");
var targetWord = JSON.parse("<%= j @target_word.to_json.html_safe %>");
var $activityDiv = createElem("div", null, "activity-div");
$(".container").empty()
							 .append(
								 $scoreboardPartial,
								 $headerPartial,
								 $directionsPartial,
								 $activityDiv
							 ).hide()
							 .fadeIn("slow");
var $points = $(".scoreboard-points");
var $scoreboardTimer = $(".scoreboard-timer");
var timerID = startCountup($scoreboardTimer, 0);
var $regex = /^[a-zA-Z0-9 .';,?!-]+$/;
var newPointsTotal = 0;
startSentenceStemActivity();

$(".container").on("click", ".continue-btn", function() {
	var $btn = $(this);

	if ($btn.hasClass("start-word-relationship-activity")) {
		giveDirections("How are the two words above connected or related?");
		updateProgress(25);
		addPoints(750);
		flashPointsUpdate(arrowSuccess());
		$activityDiv.empty();
		startWordRelationshipActivity();
	} else if ($btn.hasClass("start-leksi-tale-activity")) {
		giveDirections(
			"Write a very short story, poem, song, etc. that includes the word " +
			"above and two of your other words, which are down below. It can be " +
			"real or fake - be creative and have fun with it!"
		);
		updateProgress(50);
		addPoints(1333);
		flashPointsUpdate(arrowSuccess());
		$activityDiv.empty();
		startLeksiTaleActivity();
	} else if ($btn.hasClass("describe-me-activity")) {
		giveDirections("Answer the question below in complete sentences.");
		startDescribeMeActivity();
	} else if ($btn.hasClass("review-activity")) {
		startReviewActivity();
	}

	$btn.parent().remove();
});

/***********************
	 ACTIVITY FUNCTIONS
************************/

function startSentenceStemActivity() {
	const $sentStemsPartial = $("<%= j render(partial: 'games/freestyle/sent_stems', locals: { sent_stems: @sent_stems }) %>");
	$activityDiv.append($sentStemsPartial);
	giveDirections("Complete the sentences below.");
	const $textarea = $("#" + targetWord.id).focus();

	$textarea.on("input", function() {
		var value = $(this).val().trim();

		if (value.length > 0 && $regex.test(value)) {
			showContinueBtn("start-word-relationship-activity");
		} else {
			$(".fixed-bottom").remove();
		}
	});
}

function startWordRelationshipActivity() {
	getAnotherFreestyleWord(targetWord.id).done(function(secondWord) {
		$(".target-word-header-div").append("+ " + secondWord.name);
		const $textarea = createTextarea();
		$activityDiv.append($textarea);
		$textarea.attr("placeholder", "Type in here...").focus();

		$textarea.on("input", function() {
			var value = $(this).val().trim();

			if (value.length > 0 && $regex.test(value)) {
				 showContinueBtn("start-leksi-tale-activity");
			} else {
				$(".fixed-bottom").remove();
			}
		});
	});
}

function startLeksiTaleActivity() {
	getMyLeksiNames().done(function(names) {
		$(".target-word-header-div").text(targetWord.name);
		var $textarea = createTextarea();
		var limit = names.length - 3;
		const $wordsPartial = $("<%= j render(partial: 'games/freestyle/words') %>");
		$activityDiv.append($textarea, $wordsPartial);
		$textarea.attr("placeholder", "Type in here...").focus();

		$textarea.on("input", function() {
			var value = $(this).val().trim();

			highlightUsedWord(value);

			if (hasThreeOrMoreWords(value, names, limit) && $regex.test(value)) {
				 showContinueBtn("start-describe-me-activity");
			} else {
				$(".fixed-bottom").remove();
			}
		});

		$(".container").on("click", ".badge-default", function() {
			$badge = $(this);
			deactivateBadges();
			activateBadge($badge);
			console.log("Clicked", $(this).text());
		});
	});
}

function startDescribeMeActivity() {
	console.log("Starting Describe Me Activity");
}

/***********************
		HELPER FUNCTIONS
************************/

function activateBadge($badge) {
	$badge.removeClass("badge-default").addClass("badge-primary");
}

function deactivateBadges() {
	$(".badge-primary").removeClass("badge-primary")
										 .addClass("badge-default");
}

function highlightUsedWord(value) {

}

function hasThreeOrMoreWords(value, names, limit) {
	var words = $.unique(value.split(" "));
	var numWords = names.notIn(words).length
	return numWords <= limit;
}

Array.prototype.notIn = function(array) {
	return $(this).not(array).get();
};

function addPoints(points) {
	newPointsTotal += points;
	$points.html(newPointsTotal);
};

function removePoints(points) {
	if (newPointsTotal > 0) {
		newPointsTotal -= points;
		$points.html(newPointsTotal);
	}
};

function flashPointsUpdate($arrow) {
	$arrow.css("opacity", "1");

	setTimeout(function() {
		$arrow.css("opacity", "0.1");
	}, 300);
}

function arrowSuccess() {
	return $(".fa-arrow-up.text-success");
}

function arrowDanger() {
	return $(".fa-arrow-down.text-danger");
}

function updateProgress(value) {
	var $progressBar = $(".progress-bar");
	$progressBar.attr("aria-valuenow", value)
							.attr("style", "width: " + value + "%;")
							.text(value + "%");
};

function startCountup($section, seconds) {
	return setInterval(function() {
		seconds++;
		$section.html(seconds);
	}, 1000);
}

function createTextarea() {
	return createElem("textarea", "form-control");
}

function getMyLeksiNames() {
	return getData("/myLeksi/names");
}

function getAnotherFreestyleWord(targetWordID) {
	return getData("/games/word_relationships?word_id=" + targetWordID);
}

function getData(path) {
	return $.get(path, function() {}, "json");
}

function showContinueBtn(_class) {
	if (!$(".fixed-bottom").length) {
		$(".container").append(
			createElem("div", "fixed-bottom mb-0")
			.append(
				createBtn(
					"btn-primary btn-block btn-lg continue-btn " + _class, "Continue"
				)
			)
		);
	}
}

function giveDirections(directions) {
	$(".game-directions").html(directions);
};

function createBtn(_class, text) {
	return createElem("button", "btn " + _class).text(text.trim());
}

function createElem(elem, elemClass, elemID) {
	_class = elemClass || null;
	_id = elemID || null;
	return $("<" + elem + ">", { class: _class, id: _id });
}
